# Настройка автодеплоя при пуше в main (GitHub Actions)

При каждом `git push origin main` GitHub автоматически подключается к твоему серверу по SSH и выполняет обновление: `git pull`, `npm install`, `npm run build`, перезапуск сервиса `amazon-monitor`.

---

## Что нужно заранее

- Репозиторий на **GitHub**.
- Сервер с **Linux** (Ubuntu/Debian и т.п.), куда ты уже умеешь заходить по SSH.
- На сервере уже развёрнут проект (запускался `deploy.sh` или вручную настроен systemd), сервис `amazon-monitor` существует и запускается из директории с проектом (например `~/amazon-checker` или `~/check-stuff`).

---

## Шаг 1. SSH-ключ для деплоя

Нужен отдельный **приватный** ключ, который GitHub Actions будет использовать для входа на сервер. Можно использовать существующий ключ с твоего компьютера или сгенерировать новый только для деплоя.

### Вариант А: использовать существующий ключ

Если ты уже заходишь на сервер по SSH с ключом (например `~/.ssh/id_rsa`):

1. На своём компьютере (macOS/Linux) открой терминал.
2. Покажи содержимое **приватного** ключа (не путай с `.pub`):
   ```bash
   cat ~/.ssh/id_rsa
   ```
3. Скопируй вывод **целиком**, включая строки `-----BEGIN ... KEY-----` и `-----END ... KEY-----`. Это понадобится для секрета в GitHub.

### Вариант Б: создать новый ключ только для деплоя

1. На своём компьютере:
   ```bash
   ssh-keygen -t ed25519 -C "github-deploy" -f ~/.ssh/github_deploy -N ""
   ```
2. Просмотр приватного ключа (для GitHub):
   ```bash
   cat ~/.ssh/github_deploy
   ```
   Скопируй вывод целиком.
3. Просмотр публичного ключа (для сервера):
   ```bash
   cat ~/.ssh/github_deploy.pub
   ```
   Скопируй эту одну строку — добавим её на сервер в следующий шаг.

---

## Шаг 2. Добавить публичный ключ на сервер

Нужно, чтобы сервер разрешал вход под твоим пользователем с этим ключом.

1. Подключись к серверу:
   ```bash
   ssh твой_пользователь@IP_сервера
   ```
2. Открой или создай файл авторизованных ключей:
   ```bash
   mkdir -p ~/.ssh
   nano ~/.ssh/authorized_keys
   ```
3. Вставь **одну строку** публичного ключа (из шага 1, вариант Б — `github_deploy.pub`, или если используешь вариант А — содержимое твоего `~/.ssh/id_rsa.pub`). Сохрани файл (в nano: Ctrl+O, Enter, Ctrl+X).
4. Права (важно):
   ```bash
   chmod 700 ~/.ssh
   chmod 600 ~/.ssh/authorized_keys
   ```
5. Проверь вход с того же компьютера с новым ключом (если создавал отдельный):
   ```bash
   ssh -i ~/.ssh/github_deploy твой_пользователь@IP_сервера
   ```
   Должен войти без пароля. Выйди: `exit`.

---

## Шаг 3. Разрешить перезапуск сервиса без пароля (sudo)

GitHub Actions по SSH выполняет команду `sudo systemctl restart amazon-monitor`. Чтобы она выполнялась без ввода пароля:

1. На сервере открой список правил sudo:
   ```bash
   sudo visudo
   ```
2. В **конец файла** добавь строку (замени `твой_пользователь` на реальное имя пользователя, под которым заходишь по SSH):
   ```
   твой_пользователь ALL=(ALL) NOPASSWD: /bin/systemctl restart amazon-monitor
   ```
3. Сохрани и выйди (в nano: Ctrl+O, Enter, Ctrl+X).
4. Проверь с сервера:
   ```bash
   sudo systemctl restart amazon-monitor
   ```
   Пароль спрашивать не должно.

---

## Шаг 4. Секреты в репозитории на GitHub

1. Открой свой репозиторий на GitHub.
2. Перейди: **Settings** → **Secrets and variables** → **Actions**.
3. Нажми **New repository secret** и по очереди создай секреты:

| Name           | Value (пример)                          | Описание |
|----------------|-----------------------------------------|----------|
| `DEPLOY_HOST`  | `123.45.67.89` или `server.example.com` | IP или hostname сервера |
| `DEPLOY_USER`  | `ubuntu` или твой логин                 | Пользователь SSH |
| `DEPLOY_SSH_KEY` | (весь вывод `cat ~/.ssh/id_rsa` или `cat ~/.ssh/github_deploy`) | Приватный SSH-ключ целиком |
| `DEPLOY_PATH`  | `~/amazon-checker` или `~/check-stuff`   | Путь к папке проекта на сервере. Можно не создавать — тогда по умолчанию используется `~/amazon-checker` |

Для `DEPLOY_SSH_KEY` вставляй ключ **полностью**, включая первую и последнюю строки (`-----BEGIN ... KEY-----` и `-----END ... KEY-----`), без лишних пробелов в начале/конце.

---

## Шаг 5. Репозиторий на сервере и ветка main

На сервере в папке проекта должен быть настроен `git remote` на этот же репозиторий GitHub, и ветка `main` должна существовать.

1. Подключись к серверу и перейди в папку проекта:
   ```bash
   ssh твой_пользователь@IP_сервера
   cd ~/amazon-checker   # или cd ~/check-stuff
   ```
2. Проверь remote:
   ```bash
   git remote -v
   ```
   Должен быть `origin` с URL твоего репозитория (например `https://github.com/твой_ник/check-stuff.git` или `git@github.com:твой_ник/check-stuff.git`).
3. Если репозиторий был склонирован с другой веткой по умолчанию, убедись что есть ветка `main` и она отслеживает origin:
   ```bash
   git fetch origin
   git branch -a
   git checkout main
   git pull origin main
   ```

После этого при пуше в `main` с твоего компьютера GitHub Actions сможет на сервере выполнить `git pull origin main` и подтянуть последние коммиты.

---

## Шаг 6. Первый запуск деплоя

1. Закоммить и запушь изменения (в том числе добавленный файл `.github/workflows/deploy.yml`):
   ```bash
   git add .github/workflows/deploy.yml DEPLOY_SETUP.md
   git commit -m "Add GitHub Actions auto-deploy"
   git push origin main
   ```
2. На GitHub открой вкладку **Actions**. Должен появиться запуск workflow **Deploy to server**.
3. Открой его и посмотри лог. Если все секреты и права настроены верно, шаг **Setup SSH and deploy** завершится зелёным.
4. На сервере проверь, что сервис работает и код обновился:
   ```bash
   sudo systemctl status amazon-monitor
   cd ~/amazon-checker && git log -1 --oneline
   ```

---

## Что делать при ошибках

- **Permission denied (publickey)**  
  Проверь: на GitHub в секрете `DEPLOY_SSH_KEY` вставлен именно **приватный** ключ; на сервере в `~/.ssh/authorized_keys` добавлен соответствующий **публичный** ключ; пользователь в `DEPLOY_USER` совпадает с тем, у кого лежит этот `authorized_keys`.

- **sudo: no tty present** / запрос пароля  
  Проверь шаг 3: в `visudo` добавлена строка с `NOPASSWD: /bin/systemctl restart amazon-monitor` для пользователя из `DEPLOY_USER`.

- **cd: ... No such file or directory**  
  Проверь `DEPLOY_PATH`: на сервере должна существовать эта директория (например `~/amazon-checker`). Убедись, что путь записан так, как его понимает твой shell (например `~/amazon-checker` или `/home/ubuntu/amazon-checker`).

- **git pull** падает с ошибкой  
  На сервере в этой директории выполни `git status` и `git remote -v`. Должен быть настроен `origin` на твой репозиторий, ветка `main` должна существовать. При необходимости настрой доступ (HTTPS с токеном или SSH-ключ на сервере для GitHub).

- **npm run build** или **systemctl restart** падает  
  Смотри полный лог в Actions: там будет вывод команд с сервера. Исправь ошибку на сервере вручную (зависимости, пути, имя сервиса), затем снова запушь в `main` для повторного деплоя.

---

## Краткая сводка

1. Создай/используй SSH-ключ, добавь **публичный** ключ в `~/.ssh/authorized_keys` на сервере.
2. В `visudo` добавь NOPASSWD для `systemctl restart amazon-monitor`.
3. В GitHub в репозитории добавь секреты: `DEPLOY_HOST`, `DEPLOY_USER`, `DEPLOY_SSH_KEY`, при желании `DEPLOY_PATH`.
4. На сервере в папке проекта настроен `git remote origin` на этот репозиторий, ветка `main`.
5. После `git push origin main` деплой запускается автоматически; результат смотри во вкладке **Actions**.

Файл `.env` на сервере при деплое не перезаписывается (он в `.gitignore`), все переменные окружения остаются как ты их настроил.
